(()=>{"use strict";function e(e,t){const a=Math.pow(t,2);return 0===e?"top-left":e===t-1?"top-right":e<t?"top":e===a-t?"bottom-left":e===a-1?"bottom-right":e<a&&e>a-t?"bottom":(e+1)%t==0&&e!==t-1&&e!==a-1?"right":e%t==0&&0!==e&&e!==a-t?"left":"center"}function t(e,t,a,s){let i=null;const r=[];let l=e,h=e,c=e,n=e,o=e,d=e,m=e,g=e;"move"===s&&(i=t?.maxMoveDistance),"attack"===s&&(i=t?.maxAttackDistance);for(let e=0;e<i;e++)l>=a&&l%a!=0&&8!==l&&(l-=a+1,r.push(l)),h>=a&&(h-=a,r.push(h)),c>=a&&c%a!=a-1&&(c-=a-1,r.push(c)),n%a!=a-1&&(n+=1,r.push(n)),o<=Math.pow(a,2)-a&&o%a!=a-1&&(o+=a+1,r.push(o)),d<=Math.pow(a,2)-a&&(d+=a,r.push(d)),m<=Math.pow(a,2)-a&&m%a!=0&&(m+=a-1,r.push(m)),g%a!=0&&(g-=1,r.push(g));if("attack"===s){const e=Math.floor(h/a),t=Math.floor(d/a),s=g%a,i=n&a;for(let l=e;l<=t;l++)for(let e=s;e<=i;e++)r.push(l*a+e)}return r.filter((e=>e>=0&&e<a**2))}function a(e){return e[Math.floor(Math.random()*e.length)]}class s{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(t){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){const a=document.createElement("div");a.classList.add("cell","map-tile",`map-tile-${e(t,this.boardSize)}`),a.addEventListener("mouseenter",(e=>this.onCellEnter(e))),a.addEventListener("mouseleave",(e=>this.onCellLeave(e))),a.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(a)}this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),r.style.width=`${a.character.health}%`,i.appendChild(r),s.appendChild(i),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t="yellow"){this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",(()=>{s.removeChild(i),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}const i={levelOne:"prairie",levelTwo:"desert",levelThree:"arctic",levelFour:"mountain"},r="auto",l="pointer",h="crosshair",c="not-allowed";class n{constructor(){this.charactersList=[],this.playerSelected=null,this.level=1,this.points=0,this.statistic=[]}static from(e){return"object"==typeof e?e:null}}class o{constructor(e=1,t="generic"){if(this.type=t,this.level=e,this.health=50,this.attack=0,this.defence=0,"Character"===new.target.name)throw new Error("–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Å–∞ —á–µ—Ä–µ–∑ new Character(level)")}levelUp(){this.level+=1,this.attack=Math.floor(Math.max(this.attack,this.attack*(80+this.health)/100)),this.defence=Math.floor(Math.max(this.defence,this.defence*(80+this.health)/100)),this.health+=80,this.health>100&&(this.health=100)}get infoCharacter(){return`üéñ${this.level}‚öî${this.attack}üõ°${this.defence}‚ù§${this.health}`}}class d{constructor(e,t){if(!(e instanceof o))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class m{constructor(){this.characters=new Set}add(e){if(this.characters.has(e))throw new Error(`–≠—Ç–æ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂ ${e.type} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);this.characters.add(e)}addAll(e){this.characters=new Set([...this.characters,...e])}clearAllSet(){this.characters.clear()}deleteCharacter(e){this.characters.delete(e)}}class g extends o{constructor(e,t="bowman"){super(e,t),this.attack=25,this.defence=25,this.maxMoveDistance=2,this.maxAttackDistance=2}}class y extends o{constructor(e,t="swordsman"){super(e,t),this.attack=40,this.defence=10,this.maxMoveDistance=4,this.maxAttackDistance=1}}class p extends o{constructor(e,t="magician"){super(e,t),this.attack=10,this.defence=40,this.maxMoveDistance=1,this.maxAttackDistance=4}}class u extends o{constructor(e,t="vampire"){super(e,t),this.attack=25,this.defence=25,this.maxMoveDistance=2,this.maxAttackDistance=2}}class P extends o{constructor(e,t="undead"){super(e,t),this.attack=40,this.defence=10,this.maxMoveDistance=4,this.maxAttackDistance=1}}class v extends o{constructor(e,t="daemon"){super(e,t),this.attack=10,this.defence=10,this.maxMoveDistance=1,this.maxAttackDistance=4}}function*S(e,t){const a=Math.floor(Math.random()*t+1),s=e[Math.floor(Math.random()*e.length)];yield new s(a)}function f(e,t,a){const s=[];for(let i=0;i<a;i++)s.push(S(e,t).next().value);return s}const C=new s;C.bindToDOM(document.querySelector("#game-container"));const L=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),w=new class{constructor(e,t){this.gamePlay=e,this.stateService=t,this.gameState=new n,this.playersTeam=new m,this.enemysTeam=new m,this.players=[g,y,p],this.enemys=[u,P,v],this.addEventListeners()}init(){this.gamePlay.drawUi(i.levelOne),this.playersTeam=new m,this.enemysTeam=new m,this.gameState.charactersList=[],this.playersTeam.addAll(f(this.players,1,2)),this.enemysTeam.addAll(f(this.enemys,1,2)),this.addCharactersPosition(this.playersTeam,this.getPlayerPositions()),this.addCharactersPosition(this.enemysTeam,this.getEnemyPositions());const e=this.stateService.load();this.gameState.statistic=e.statistic,this.gamePlay.redrawPositions(this.gameState.charactersList)}addEventListeners(){this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener((()=>{this.startingNewGame()})),this.gamePlay.addSaveGameListener((()=>{this.savingGame()})),this.gamePlay.addLoadGameListener((()=>{this.loadingSaveGame()}))}nextLevel(){this.gameState.level++;for(const e of this.playersTeam.characters)e.levelUp()}switchLevel(){let e;switch(this.gameState.level){case 1:this.gamePlay.drawUi(i.levelOne),this.playersTeam.add(S(this.players,1).next().value),this.addCharacterPosition(this.playersTeam,this.getPlayerPositions()),this.gamePlay.redrawPositions(this.gameState.charactersList);break;case 2:this.gamePlay.drawUi(i.levelTwo),e=S(this.players,1).next().value,this.playersTeam.add(e),this.enemysTeam.addAll(f(this.enemys,2,2)),this.addCharacterPosition(e,this.getPlayerPositions()),this.addCharactersPosition(this.enemysTeam,this.getEnemyPositions()),this.gamePlay.redrawPositions(this.gameState.charactersList);break;case 3:this.gamePlay.drawUi(i.levelThree),e=S(this.players,1).next().value,this.playersTeam.add(e),this.enemysTeam.addAll(f(this.enemys,3,2)),this.addCharacterPosition(e,this.getPlayerPositions()),this.addCharactersPosition(this.enemysTeam,this.getEnemyPositions()),this.gamePlay.redrawPositions(this.gameState.charactersList);break;case 4:this.gamePlay.drawUi(i.levelFour),e=S(this.players,1).next().value,this.playersTeam.add(e),this.enemysTeam.addAll(f(this.enemys,4,2)),this.addCharacterPosition(e,this.getPlayerPositions()),this.addCharactersPosition(this.enemysTeam,this.getEnemyPositions()),this.gamePlay.redrawPositions(this.gameState.charactersList)}}enemyAttack(){const e=this.gameState.charactersList.filter((e=>e.character instanceof g||e.character instanceof y||e.character instanceof p)),s=this.gameState.charactersList.filter((e=>e.character instanceof u||e.character instanceof P||e.character instanceof v));let i=null,r=null;for(const a of e)for(const e of s)t(e.position,e.character,this.gamePlay.boardSize,"attack").includes(a.position)&&(i=a,r=e);if(i){this.gamePlay.selectCell(i.position,"red");const e=Math.max(r.character.attack-i.character.defence,.1*r.character.attack);this.gamePlay.showDamage(i.position,e).then((()=>{i.character.health-=e,i.character.health<=0&&(this.delectChar(i.position),this.playersTeam.deleteCharacter(i.character))})).then((()=>{this.gamePlay.cells.forEach((e=>e.classList.remove("selected-red"))),this.gamePlay.redrawPositions(this.gameState.charactersList),this.gameState.playerSelected=null})).then((()=>{this.gameStatistic()}))}else{if(r=s[Math.floor(Math.random()*s.length)],!r)return;const e=t(r.position,r.character,this.gamePlay.boardSize,"attack");for(const t of e)for(const a of this.gameState.charactersList)t===a.position&&e.splice(e.indexOf(a.position),1);const i=a(this.getEnemyPositions());r.position=i,this.gamePlay.redrawPositions(this.gameState.charactersList)}}gameStatistic(){let e=this.gameState.statistic.reduce(((e,t)=>e+t),0);0===this.playersTeam.characters.size&&(this.gameState.statistic.push(this.gameState.points),s.showMessage(`–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏! –£ –≤–∞—Å –æ—á–∫–æ–≤ - ${e+this.gameState.points}!`)),0===this.enemysTeam.characters.size&&this.gameState.level<4&&(this.gameState.statistic.push(this.gameState.points),this.nextLevel(),s.showMessage(`–í—ã –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å ${this.gameState.level}! –£ –≤–∞—Å –æ—á–∫–æ–≤ –∑–∞ —É—Ä–æ–≤–µ–Ω—å - ${this.gameState.points}!`),this.switchLevel()),0===this.enemysTeam.characters.size&&4===this.gameState.level&&(this.gameState.statistic.push(this.gameState.points),s.showMessage(`–í—ã –ø—Ä–æ—à–ª–∏ –∏–≥—Ä—É! –£ –≤–∞—Å –æ—á–∫–æ–≤ ${e+this.gameState.points}!`))}characterAttack(e,t,a){const s=Math.max(t.attack-a.defence,.1*t.attack);t&&a&&this.gamePlay.showDamage(e,s).then((()=>{a.health-=s,this.gameState.points+=s,a.health<=0&&(this.delectChar(e),this.enemysTeam.deleteCharacter(a))})).then((()=>{this.gameState.playerSelected=null,this.gamePlay.redrawPositions(this.gameState.charactersList)})).then((()=>{this.gameStatistic(),this.enemyAttack()}))}delectChar(e){this.gameState.charactersList.splice(this.gameState.charactersList.indexOf(this.getCharInCell(e)),1)}onCellClick(e){if(this.isPlayers(e)&&(this.gamePlay.cells.forEach((e=>e.classList.remove("selected"))),this.gamePlay.selectCell(e),this.gameState.playerSelected=e),!this.gameState.playerSelected||this.isPlayerDistance(e,"attack")||this.isPlayerDistance(e,"move")||this.isEnemy(e)||this.isPlayers(e)||s.showError(`–Ø—á–µ–π–∫–∞ –Ω–æ–º–µ—Ä - ${e} –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞—è`),!this.getCharInCell(e)&&this.isPlayerDistance(e,"move")&&(this.changeCellPlayer(e),this.gamePlay.cells.forEach((e=>e.classList.remove("selected-green")))),this.getSelectedPlayer()&&this.isPlayerDistance(e,"attack")&&this.isEnemy(e)){const t=this.getSelectedPlayer().character,a=this.getCharInCell(e).character;this.characterAttack(e,t,a),this.gamePlay.cells.forEach((e=>e.classList.remove("selected")))}}onCellEnter(e){this.isPlayers(e)?this.gamePlay.setCursor(l):this.gamePlay.setCursor(r),this.isPlayerDistance(e,"move")&&!this.getCharInCell(e)&&(this.gamePlay.setCursor(l),this.gamePlay.selectCell(e,"green")),this.isPlayerDistance(e,"attack")&&this.isEnemy(e)&&(this.gamePlay.setCursor(h),this.gamePlay.selectCell(e,"red")),!this.gameState.playerSelected||this.isPlayerDistance(e,"attack")||this.isPlayerDistance(e,"move")||this.isEnemy(e)||this.isPlayers(e)||this.gamePlay.setCursor(c),this.getPositionsChars().includes(e)&&this.gamePlay.showCellTooltip(this.getCharInCell(e).character.infoCharacter,e)}getSelectedPlayer(){return this.gameState.charactersList.find((e=>e.position===this.gameState.playerSelected))}getPlayerPositions(){this.playerPosition=[];for(let e=0,t=1;this.playerPosition.length<2*this.gamePlay.boardSize;e+=this.gamePlay.boardSize,t+=this.gamePlay.boardSize)this.playerPosition.push(e,t);return this.playerPosition}getEnemyPositions(){this.enemyPosition=[];for(let e=this.gamePlay.boardSize-2,t=this.gamePlay.boardSize-1;this.enemyPosition.length<2*this.gamePlay.boardSize;e+=this.gamePlay.boardSize,t+=this.gamePlay.boardSize)this.enemyPosition.push(e,t);return this.enemyPosition}changeCellPlayer(e){this.getSelectedPlayer(e).position=e,this.gamePlay.deselectCell(this.gameState.playerSelected),this.gamePlay.redrawPositions(this.gameState.charactersList),this.gameState.playerSelected=null,this.enemyAttack()}onCellLeave(e){this.gamePlay.hideCellTooltip(e),this.gamePlay.cells.forEach((e=>e.classList.remove("selected-red"))),this.gamePlay.cells.forEach((e=>e.classList.remove("selected-green"))),this.gamePlay.setCursor(r)}checkEnemyPresentInCell(e){return this.enemysTeam.find((t=>t.position===e))}getPositionsChars(){return this.gameState.charactersList.map((e=>e.position))}isPlayerDistance(e,a){if(this.getSelectedPlayer())return t(this.getSelectedPlayer().position,this.getSelectedPlayer().character,this.gamePlay.boardSize,a).includes(e)}addCharactersPosition(e,t){const s=[...t];for(const t of e.characters){const e=a(s);this.gameState.charactersList.push(new d(t,e)),s.splice(s.indexOf(e),1)}}addCharacterPosition(e,t){const s=[...t],i=a(s);this.gameState.charactersList.push(new d(e,i)),s.splice(s.indexOf(i),1)}getCharInCell(e){return this.gameState.charactersList.find((t=>t.position===e))}isPlayers(e){if(this.getCharInCell(e)){const t=this.getCharInCell(e);return this.players.some((e=>t.character instanceof e))}return!1}isEnemy(e){if(this.getCharInCell(e)){const t=this.getCharInCell(e);return this.enemys.some((e=>t.character instanceof e))}return!1}startingNewGame(){this.stateService.save(n.from({charactersList:[...this.gameState.charactersList],playerSelected:this.gameState.playerSelected,level:this.gameState.level,points:this.gameState.points,statistic:[...this.gameState.statistic]})),this.init();const e=this.stateService.load();this.gameState.level=1,this.gameState.playerSelected=null,this.gameState.points=0,this.gameState.statistic=e.statistic,console.log(this.gameState.statistic),console.log(e)}savingGame(){this.stateService.save(n.from(this.gameState)),localStorage.getItem("state")||s.showError("–ò–≥—Ä–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞("),s.showMessage("–ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞)")}loadingSaveGame(){const e=this.stateService.load();if(e){this.gamePlay.drawUi(i[Object.keys(i)[e.level-1]]),this.gameState.level=e.level,this.gameState.points=e.points,this.gameState.statistic=e.statistic,this.playersTeam=new m,this.enemysTeam=new m,this.gameState.playerSelected=e.playerSelected,this.gameState.charactersList=[];for(const t of e.charactersList){let e;"bowman"===t.character.type?(e=new g(t.character.level),this.playersTeam.add(e)):"swordsman"===t.character.type?(e=new y(t.character.level),this.playersTeam.add(e)):"magician"===t.character.type?(e=new p(t.character.level),this.playersTeam.add(e)):"vampire"===t.character.type?(e=new u(t.character.level),this.enemysTeam.add(e)):"undead"===t.character.type?(e=new P(t.character.level),this.enemysTeam.add(e)):"daemon"===t.character.type&&(e=new v(t.character.level),this.enemysTeam.add(e)),e.health=t.character.health,this.gameState.charactersList.push(new d(e,t.position))}this.gamePlay.redrawPositions(this.gameState.charactersList)}else s.showMessage("–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è(")}}(C,L);w.init()})();